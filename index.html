<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5.dev">
<meta name="author" content="Servicio de las Tecnologías de la Información y las Comunicaciones - Universidad de Almería">
<title>DDD - Diseño dirigido por el dominio</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-right">
<div id="header">
<h1>DDD - Diseño dirigido por el dominio</h1>
<div class="details">
<span id="author" class="author">Servicio de las Tecnologías de la Información y las Comunicaciones - Universidad de Almería</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de contenidos</div>
<ul class="sectlevel1">
<li><a href="#trueresumen">Resumen</a></li>
<li><a href="#trueintroducci-n">1. Introducción</a>
<ul class="sectlevel2">
<li><a href="#trueconfiguraci-n-inicial">1.1. Configuración inicial</a></li>
</ul>
</li>
<li><a href="#trueejemplo-a-desarrollar">2. Ejemplo a desarrollar</a>
<ul class="sectlevel2">
<li><a href="#truecrear-curso">2.1. Crear curso</a></li>
<li><a href="#truelistar-cursos">2.2. Listar cursos</a></li>
<li><a href="#trueregistrar-a-un-alumno">2.3. Registrar a un alumno</a></li>
<li><a href="#truelistar-alumnos">2.4. Listar alumnos</a></li>
<li><a href="#truematricular-a-un-alumno-en-un-curso">2.5. Matricular a un alumno en un curso</a></li>
</ul>
</li>
<li><a href="#trueaplicaci-n-progresiva-de-las-t-cnicas-de-ddd">3. Aplicación progresiva de las técnicas de DDD</a>
<ul class="sectlevel2">
<li><a href="#trueestructura-de-archivos-objetivo">3.1. Estructura de archivos objetivo</a></li>
<li><a href="#truecreaci-n-del-caso-de-uso">3.2. Creación del caso de uso</a></li>
<li><a href="#trueusar-el-lenguaje-ub-cuo-dentro-del-caso-de-uso">3.3. Usar el lenguaje ubícuo dentro del caso de uso</a></li>
<li><a href="#trueeliminar-las-referencias-http-del-caso-de-uso">3.4. Eliminar las referencias HTTP del caso de uso</a></li>
<li><a href="#trueeliminar-las-referencias-a-persistencia-en-el-caso-de-uso">3.5. Eliminar las referencias a persistencia en el caso de uso</a></li>
<li><a href="#trueempujar-la-l-gica-de-negocio-desde-el-caso-de-uso-al-dominio">3.6. Empujar la lógica de negocio desde el caso de uso al dominio</a></li>
<li><a href="#truegeneraci-n-de-identificadores">3.7. Generación de identificadores</a></li>
<li><a href="#truemejora-de-la-implementaci-n-del-repositorio-mysql">3.8. Mejora de la implementación del repositorio MySQL</a></li>
<li><a href="#truesustituci-n-del-mecanismo-de-persistencia">3.9. Sustitución del mecanismo de persistencia</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/logocloudstic.png" alt="logocloudstic.png">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueresumen"><a class="anchor" href="#trueresumen"></a>Resumen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>AAA</p>
</div>
<div class="ulist">
<div class="title">Objetivos</div>
<ul>
<li>
<p>xxx</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Disponible el <a href="https://github.com/ualmtorres/enrollments.git">repositorio</a> usado en este tutorial.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueintroducci-n"><a class="anchor" href="#trueintroducci-n"></a>1. Introducción</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="trueconfiguraci-n-inicial"><a class="anchor" href="#trueconfiguraci-n-inicial"></a>1.1. Configuración inicial</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ nest new enrollments

$ npm install --save @nestjs/typeorm typeorm mysql
$ npm install --save @nestjs/swagger swagger-ui-express</code></pre>
</div>
</div>
<div class="paragraph">
<p>Archivo <code>docker-compose.yml</code> con MySQL y Adminer</p>
</div>
<script src="https://gist.github.com/ualmtorres/4af6f43e58fca549b6c80223bfe1e691.js"></script>
<div class="paragraph">
<p>Script de inicialización de la base de datos</p>
</div>
<script src="https://gist.github.com/ualmtorres/dd1688d817f74c1911fce54424535633.js"></script>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueejemplo-a-desarrollar"><a class="anchor" href="#trueejemplo-a-desarrollar"></a>2. Ejemplo a desarrollar</h2>
<div class="sectionbody">
<div class="paragraph">
<p>CASO DE USO 1: Crear un curso</p>
</div>
<div class="ulist">
<ul>
<li>
<p>se introduce el nombre de un curso de entre 3 y 255 caracteres</p>
</li>
<li>
<p>se introduce un número máximo de plazas (no puede ser mayor de 8 ni menor que uno)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>CASO DE USO 2: Listar cursos</p>
</div>
<div class="ulist">
<ul>
<li>
<p>mostrar los cursos disponibles en la plataforma</p>
</li>
<li>
<p>filtrar cursos por nombre</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>CASO DE USO 3: Registar un alumno</p>
</div>
<div class="ulist">
<ul>
<li>
<p>se introduce un nombre, entre 2 y 255 caracteres</p>
</li>
<li>
<p>se introduce un NIF (8 dígitos y una letra, no hay que validar el checksum)</p>
</li>
<li>
<p>se introduce un email válido</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>CASO DE USO 4: Listar los alumnos</p>
</div>
<div class="ulist">
<ul>
<li>
<p>mostrar los alumnos actuales de la plataforma</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>CASO DE USO 5: Matricular un alumno en un curso</p>
</div>
<div class="ulist">
<ul>
<li>
<p>se introduce un id de alumno y un id de curso</p>
</li>
<li>
<p>comprobar que no se pueda superar el número máximo de matriculas permitidas</p>
</li>
<li>
<p>no se puede matricular el mismo alumno dos veces</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Archivo <code>main.ts</code> para incluir Swagger</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // Configurar títulos de documnentación
  const options = new DocumentBuilder()
    .setTitle('Enrollments REST API')
    .setDescription('Enrollments REST API')
    .setVersion('1.0')
    .build();
  const document = SwaggerModule.createDocument(app, options);

  // La ruta en que se sirve la documentación
  SwaggerModule.setup('docs', app, document);

  await app.listen(3000);
}
bootstrap();</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="truecrear-curso"><a class="anchor" href="#truecrear-curso"></a>2.1. Crear curso</h3>
<div class="listingblock">
<div class="title">Archivo <code>app.controller.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">import { BadRequestException, Body, Controller, Get, Post } from '@nestjs/common';
import { createConnection } from 'typeorm';
import { AppService } from './app.service';
import { ApiProperty, ApiTags } from '@nestjs/swagger';

class CreateCourseRequest { <i class="conum" data-value="1"></i><b>(1)</b>
  @ApiProperty({ example: 'Nuevo curso' })
  name: string;
  @ApiProperty({ example: 5 })
  places: number;
}

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  getHello(): string {
    return this.appService.getHello();
  }

  @Post('/courses') <i class="conum" data-value="2"></i><b>(2)</b>
  @ApiTags('courses')
  async createCourse(@Body() req: CreateCourseRequest): Promise&lt;object&gt; {
    if (req.places === undefined || req.places &lt; 1 || req.places &gt; 8) {
      throw new BadRequestException(
        'El número de plazas de un curso deber estar entre 1 y 8'
      );
    }
    if (
      req.name === undefined ||
      req.name.length &lt; 3 ||
      req.name.length &gt; 255
    ) {
      throw new BadRequestException(
        'El nombre de un curso debe estar entre 3 y 255 caracteres',
      );
    }
    const connection = await this.getConnection();

    const result = await connection.query(
      'INSERT INTO courses(name, places) VALUES(?, ?)',
      [req.name, req.places],
    );

    connection.close();

    return { courseId: result.insertId };
  }

  getConnection() { <i class="conum" data-value="3"></i><b>(3)</b>
    return createConnection({
      type: 'mysql',
      host: 'localhost',
      port: 3306,
      username: 'root',
      password: 'example',
      database: 'enrollments',
    });
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Se ha favorecido el uso de claúsulas de guarda.</p>
</li>
<li>
<p>Se ha usado RAW SQL en el método <code>query</code> en lugar de usar los métodos proporcionados por TypeORM.</p>
</li>
<li>
<p>Uso de <a href="https://docs.nestjs.com/exception-filters#built-in-http-exceptions">excepciones HTTP incorporadas</a>.</p>
</li>
<li>
<p>Uso de expresiones regulares en NIF y email.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truelistar-cursos"><a class="anchor" href="#truelistar-cursos"></a>2.2. Listar cursos</h3>
<div class="listingblock">
<div class="title">Modificaciones al archivo <code>app.controller.ts</code>.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">...
  @Get('/courses')
  @ApiTags('courses')
  @ApiQuery({ name: 'name', required: false })
  async getCourses(@Query('name') name: string): Promise&lt;object&gt; {
    const connection = await this.getConnection();

    let query = 'SELECT * FROM courses';
    let params = [];

    if (name !== undefined) {
      query += ' WHERE name = ?';
      params.push(name);
    }

    const result = await connection.query(query, params);

    connection.close();

    return result;
  }
...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueregistrar-a-un-alumno"><a class="anchor" href="#trueregistrar-a-un-alumno"></a>2.3. Registrar a un alumno</h3>
<div class="listingblock">
<div class="title">Modificaciones al archivo <code>app.controller.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">...
class CreateStudentRequest { <i class="conum" data-value="1"></i><b>(1)</b>
  @ApiProperty({ example: 'Manolo' })
  name: string;
  @ApiProperty({ example: '12345678Q' })
  nif: string;
  @ApiProperty({ example: 'mtorres@ual.es' })
  email: string;
}
...
  @Post('/students') <i class="conum" data-value="2"></i><b>(2)</b>
  @ApiTags('students')
  async createStudent(@Body() req: CreateStudentRequest): Promise&lt;object&gt; {
    if (req.name == undefined || req.name.length &lt; 2 || req.name.length &gt; 255) {
      throw new BadRequestException(
        'El nombre del estudiante tiene que tener entre 2 y 255 caracteress',
      );
    }
    if (req.nif == undefined || !/^[0-9]{8}[A-Z]$/g.test(req.nif)) {
      throw new BadRequestException('El NIF tiene que tener formato correcto');
    }
    if (
      req.email == undefined ||
      !/^(([^&lt;&gt;()\[\]\\.,;:\s@"]+(\.[^&lt;&gt;()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/g.test(
        req.email,
      )
    ) {
      throw new BadRequestException(
        'El email tiene que tener formato correcto',
      );
    }

    const connection = await this.getConnection();

    const result = await connection.query(
      'INSERT INTO students(name, nif, email) VALUES(?, ?, ?)',
      [req.name, req.nif, req.email],
    );

    connection.close();

    return {'id: ': result.insertId };
  }
...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truelistar-alumnos"><a class="anchor" href="#truelistar-alumnos"></a>2.4. Listar alumnos</h3>
<div class="listingblock">
<div class="title">Modificaciones al archivo <code>app.controller.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">...
  @Get('/students')
  @ApiTags('students')
  async getStudents(): Promise&lt;object&gt; {
    // connect DB
    const connection = await this.getConnection();

    const query = 'SELECT * FROM students ';

    const result = await connection.query(query);

    connection.close();

    return { data: result };
  }
...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truematricular-a-un-alumno-en-un-curso"><a class="anchor" href="#truematricular-a-un-alumno-en-un-curso"></a>2.5. Matricular a un alumno en un curso</h3>
<div class="listingblock">
<div class="title">Modificaciones al archivo <code>app.controller.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">...
class EnrollStudentRequest { <i class="conum" data-value="1"></i><b>(1)</b>
  @ApiProperty({ example: 1 })
  studentId: number;
}
...
  @Post('/courses/:courseId/enrollments') <i class="conum" data-value="2"></i><b>(2)</b>
  @ApiTags('courses')
  async enrollStudent(
    @Body() req: EnrollStudentRequest,
    @Param('courseId') courseId: string,
  ): Promise&lt;object&gt; {
    // connect DB
    const connection = await this.getConnection();

    const courses = await connection.query(
      'SELECT * FROM courses WHERE id = ?',
      [courseId],
    );
    if (courses.length === 0) {
      connection.close();
      throw new BadRequestException('Curso no encontrado');
    }
    const course = courses[0];

    const students = await connection.query(
      'SELECT * FROM students WHERE id = ?',
      [req.studentId],
    );
    if (students.length === 0) {
      connection.close();
      throw new BadRequestException('Estudiante no encontrado');
    }

    const courseEnrollemnts = await connection.query(
      'SELECT * FROM enrollments WHERE id_course = ?',
      [courseId],
    );
    if (courseEnrollemnts.length === course.places) {
      connection.close();
      throw new BadRequestException('El curso está lleno');
    }
    courseEnrollemnts.forEach(enrollment =&gt; {
      if (enrollment.id_student === req.studentId)
        throw new BadRequestException('El estudiante ya está matriculado');
    });

    const result = await connection.query(
      'INSERT INTO enrollments(id_course, id_student) VALUES(?, ?)',
      [courseId, req.studentId],
    );

    connection.close();
    return { enrollmentId: result.insertId };
  }
...</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueaplicaci-n-progresiva-de-las-t-cnicas-de-ddd"><a class="anchor" href="#trueaplicaci-n-progresiva-de-las-t-cnicas-de-ddd"></a>3. Aplicación progresiva de las técnicas de DDD</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="trueestructura-de-archivos-objetivo"><a class="anchor" href="#trueestructura-de-archivos-objetivo"></a>3.1. Estructura de archivos objetivo</h3>
<div class="imageblock">
<div class="content">
<img src="http://localhost:60332/afx/cache/f570f81cf83fe2c800deadaf10ff54bc.png" alt="f570f81cf83fe2c800deadaf10ff54bc.png">
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecreaci-n-del-caso-de-uso"><a class="anchor" href="#truecreaci-n-del-caso-de-uso"></a>3.2. Creación del caso de uso</h3>
<div class="paragraph">
<p>El objetivo es llevar toda la lógica que teníamos en el método de creación de un curso nuevo definido en <code>app.controller.ts</code> a un nuevo archivo <code>Application/CreateCourseUseCase.ts</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Cada caso de uso sólo debe tener un único método público. Se suele llamar <code>execute()</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear el archivo <code>Application/CreateCourseUseCase.ts</code> con una clase <code>CreateCourseUseCase.ts</code>.</p>
</li>
<li>
<p>Definir un método público <code>execute()</code>.</p>
</li>
<li>
<p>Colocar en el método <code>execute()</code> toda la lógica que había en el cuerpo del método de creación de un nuevo curso definida en <code>app.controller.ts</code>.</p>
</li>
<li>
<p>Hacer la modificaciones pertinentes en <code>execute</code></p>
</li>
<li>
<p>Definir un argumento <code>req</code> en <code>execute()</code>.</p>
</li>
<li>
<p>Definir el método <code>execute</code> como <code>async</code>.</p>
</li>
<li>
<p>Importar las excepciones HTTP.</p>
</li>
<li>
<p>Copiar el método <code>getConnection()</code> de conexión a la base de datos.</p>
</li>
<li>
<p>Importar la referencia a TypeORM.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">import { BadRequestException } from '@nestjs/common';
import { createConnection } from 'typeorm';
export class CreateCourseUseCase { <i class="conum" data-value="1"></i><b>(1)</b>
    getConnection() { <i class="conum" data-value="2"></i><b>(2)</b>
        return createConnection({
          type: 'mysql',
          host: 'localhost',
          port: 3306,
          username: 'root',
          password: 'secret',
          database: 'ual',
        });
      }

    public async execute (req) { <i class="conum" data-value="3"></i><b>(3)</b>
        if (req.places === undefined || req.places &lt; 1 || req.places &gt; 8) {
            throw new BadRequestException(
              'El número de plazas de un curso deber estar entre 1 y 8'
            );
          }
          if (
            req.name === undefined ||
            req.name.length &lt; 3 ||
            req.name.length &gt; 255
          ) {
            throw new BadRequestException(
              'El nombre de un curso debe estar entre 3 y 255 caracteres',
            );
          }
          const connection = await this.getConnection();

          const result = await connection.query(
            'INSERT INTO courses(name, places) VALUES(?, ?)',
            [req.name, req.places],
          );

          connection.close();

          return { courseId: result.insertId };
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Llamar desde el método de creación de cursos de <code>app.controller.ts</code> al método <code>execute</code> del nuevo caso de uso</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">  @Post('/courses')
  @ApiTags('courses')
  async createCourse(@Body() req: CreateCourseRequest): Promise&lt;object&gt; {
    const useCase = new CreateCourseUseCase(); <i class="conum" data-value="1"></i><b>(1)</b>
    const result = useCase.execute(req); <i class="conum" data-value="2"></i><b>(2)</b>
    return result; <i class="conum" data-value="3"></i><b>(3)</b>
  }</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Si probamos a crear un curso, todo sigue funcionando correctamente.</p>
</div>
</div>
<div class="sect2">
<h3 id="trueusar-el-lenguaje-ub-cuo-dentro-del-caso-de-uso"><a class="anchor" href="#trueusar-el-lenguaje-ub-cuo-dentro-del-caso-de-uso"></a>3.3. Usar el lenguaje ubícuo dentro del caso de uso</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Cambiar el argumento <code>req</code> en el método <code>execute</code> por dos parámetros <code>name</code> y <code>places</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">    public async execute (name: string, places: number) { <i class="conum" data-value="1"></i><b>(1)</b>
        if (places === undefined || places &lt; 1 || places &gt; 8) {
            throw new BadRequestException(
              'El número de plazas de un curso deber estar entre 1 y 8'
            );
          }
          if (
            name === undefined ||
            name.length &lt; 3 ||
            name.length &gt; 255
          ) {
            throw new BadRequestException(
              'El nombre de un curso debe estar entre 3 y 255 caracteres',
            );
          }
          const connection = await this.getConnection();

          const result = await connection.query(
            'INSERT INTO courses(name, places) VALUES(?, ?)',
            [name, places],
          );

          connection.close();

          return { courseId: result.insertId };
    }</code></pre>
</div>
</div>
</li>
<li>
<p>Actualizar la llamada al método <code>execute</code> desde <code>app.controller.ts</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">  @Post('/courses')
  @ApiTags('courses')
  async createCourse(@Body() req: CreateCourseRequest): Promise&lt;object&gt; {
    const useCase = new CreateCourseUseCase();
    const result = await useCase.execute(req.name, req.places); <i class="conum" data-value="1"></i><b>(1)</b>
    return result;
  }</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="trueeliminar-las-referencias-http-del-caso-de-uso"><a class="anchor" href="#trueeliminar-las-referencias-http-del-caso-de-uso"></a>3.4. Eliminar las referencias HTTP del caso de uso</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear una clase <code>Domain/InvalidArgumentException.ts</code> para que sea una excepción del dominio, no de HTTP.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">export class InvalidArgumentException extends Error {}</code></pre>
</div>
</div>
</li>
<li>
<p>Sustituir la excepción HTTP (<code>BadRequestException</code>) por la excepción del dominio (<code>InvalidArgumentException</code>).</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">...
    public async execute (name: string, places: number) {
        if (places === undefined || places &lt; 1 || places &gt; 8) {
            throw new InvalidArgumentException ( <i class="conum" data-value="1"></i><b>(1)</b>
              'El número de plazas de un curso deber estar entre 1 y 8'
            );
          }
          if (
            name === undefined ||
            name.length &lt; 3 ||
            name.length &gt; 255
          ) {
            throw new InvalidArgumentException ( <i class="conum" data-value="2"></i><b>(2)</b>
              'El nombre de un curso debe estar entre 3 y 255 caracteres',
            );
          }
          const connection = await this.getConnection();

          const result = await connection.query(
            'INSERT INTO courses(name, places) VALUES(?, ?)',
            [name, places],
          );

          connection.close();

          return { courseId: result.insertId };
    }
...</code></pre>
</div>
</div>
</li>
<li>
<p>Actualizar la llamada al caso de uso para que transforme el error de dominio en error HTTP.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">...
  @Post('/courses')
  @ApiTags('courses')
  async createCourse(@Body() req: CreateCourseRequest): Promise&lt;object&gt; {
    const useCase = new CreateCourseUseCase();
    try { <i class="conum" data-value="1"></i><b>(1)</b>
      const result = await useCase.execute(req.name, req.places); <i class="conum" data-value="2"></i><b>(2)</b>
      return result;
    } catch (error) {
      throw new BadRequestException(error.message); <i class="conum" data-value="3"></i><b>(3)</b>
    }
  }
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>zzz</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>La llamada tiene que ser con <code>await</code> porque el caso de uso es asíncrono.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>zzz</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="trueeliminar-las-referencias-a-persistencia-en-el-caso-de-uso"><a class="anchor" href="#trueeliminar-las-referencias-a-persistencia-en-el-caso-de-uso"></a>3.5. Eliminar las referencias a persistencia en el caso de uso</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear entidad del dominio en <code>Domain/Course.ts</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">export class Course {
    private id: number;
    private name: string;
    private places: number;

    constructor (name: string, places: number) {
        this.name = name;
        this.places = places;
    }

    public getName() { <i class="conum" data-value="1"></i><b>(1)</b>
        return this.name
    }

    public getPlaces() {
        return this.places;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Los <em>getters</em> son necesarios posteriormente para el acceso a las propiedades de la entidad por parte de los repositorios que manejen la persistencia.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Crear el repositorio de persistencia de la entidad para poder conectar el caso de uso a la persistencia.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">import { Course } from './Course';

export abstract class CourseRepository {
    abstract save(course: Course);
    // Aquí irían otros métodos p.e courseByStudent
}</code></pre>
</div>
</div>
</li>
<li>
<p>Mover la lógica de base de datos desde <code>app.controller.ts</code> a un repositorio en infraestructura <code>Infrastructure/MySQLCourseRepository.ts</code>. Se mueve a infraestructura porque es propio del mecanismo de persisntecia concreto, en este caso MySQL.</p>
<div class="listingblock">
<div class="title">Archivo <code>Infrasctructure/MySQLCourseRepository.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">import { CourseRepository } from '../Domain/CourseRepository';
import { Course } from '../Domain/Course';
import { createConnection } from 'typeorm';

export class MySQLCourseRepository extends CourseRepository {

    async save(course: Course) {
        const connection = await this.getConnection();

        const result = await connection.query(
          'INSERT INTO courses(name, places) VALUES(?, ?)',
          [course.getName(), course.getPlaces()], <i class="conum" data-value="1"></i><b>(1)</b>
        );

        connection.close();

        return result;
    }
    getConnection() {
        return createConnection({
          type: 'mysql',
          host: 'localhost',
          port: 3306,
          username: 'root',
          password: 'secret',
          database: 'ual',
        });
      }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uso de los <em>getters</em> para el acceso a las propiedades de la entidad a persistir.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Limpiar el caso de uso para sustituir la interacción con la base de datos por interacción con el repositorio.</p>
<div class="listingblock">
<div class="title">Archivo <code>Application/CreateCourseUseCase.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">import { createConnection } from 'typeorm';
import { InvalidArgumentException } from '../Domain/InvalidArgumentException';
import { CourseRepository } from '../Domain/CourseRepository';
import { Course } from '../Domain/Course';
export class CreateCourseUseCase {

    constructor(private courses: CourseRepository) {} <i class="conum" data-value="1"></i><b>(1)</b>

    public async execute (name: string, places: number) {
        if (places === undefined || places &lt; 1 || places &gt; 8) {
            throw new InvalidArgumentException (
              'El número de plazas de un curso deber estar entre 1 y 8'
            );
          }
          if (
            name === undefined ||
            name.length &lt; 3 ||
            name.length &gt; 255
          ) {
            throw new InvalidArgumentException (
              'El nombre de un curso debe estar entre 3 y 255 caracteres'
            );
          }

          const course = new Course(name, places); <i class="conum" data-value="2"></i><b>(2)</b>
          const result = await this.courses.save(course); <i class="conum" data-value="3"></i><b>(3)</b>

          return { courseId: result.insertId };
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Modificar la llamada al caso de uso en <code>app.controller.ts</code> para pasarle el repositorio de persistencia.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">...
  @Post('/courses')
  @ApiTags('courses')
  async createCourse(@Body() req: CreateCourseRequest): Promise&lt;object&gt; {
    const useCase = new CreateCourseUseCase(new MySQLCourseRepository()); <i class="conum" data-value="1"></i><b>(1)</b>
    try {
      const result = await useCase.execute(req.name, req.places);
      return result;
    } catch (error) {
      throw new BadRequestException(error.message);
    }
  }
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="trueempujar-la-l-gica-de-negocio-desde-el-caso-de-uso-al-dominio"><a class="anchor" href="#trueempujar-la-l-gica-de-negocio-desde-el-caso-de-uso-al-dominio"></a>3.6. Empujar la lógica de negocio desde el caso de uso al dominio</h3>
<div class="paragraph">
<p>Se trata de llevar la verificación del número de caracteres de un curso y su número de plazas desde <code>Application/CreateCourseUseCase.ts</code> a <code>Domain/Course.ts</code>. El objetivo es que otros casos de uso se puedan beneficiar de esa lógica si está en la entidad y así no tener que volver a implementarla. Concretamente, la llevaríamos al constructor.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Colocar la lógica de comprobación de curso correcto de la entidad <code>Domain/Course.ts</code>. En este caso lo colocamos en el constructor.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">    constructor (name: string, places: number) {
        this.name = name;
        this.places = places;

        if (places === undefined || places &lt; 1 || places &gt; 8) { <i class="conum" data-value="1"></i><b>(1)</b>
            throw new InvalidArgumentException (
              'El número de plazas de un curso deber estar entre 1 y 8'
            );
          }
          if ( <i class="conum" data-value="2"></i><b>(2)</b>
            name === undefined ||
            name.length &lt; 3 ||
            name.length &gt; 255
          ) {
            throw new InvalidArgumentException (
              'El nombre de un curso debe estar entre 3 y 255 caracteres'
            );
          }
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Lógica de comprobación del nombre de un curso</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Lógica de comprobación de plazas de un curso</td>
</tr>
</table>
</div>
</li>
<li>
<p>Quitar la lógica de comprobación de curso correcto del caso de uso <code>Application/CreateCourseUseCase.ts</code>. Ahora el caso de uso queda totalmente limpio. Se limita a crear el curso, guardarlo y devolver el identificador del curso creado.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">import { createConnection } from 'typeorm';
import { InvalidArgumentException } from '../Domain/InvalidArgumentException';
import { CourseRepository } from '../Domain/CourseRepository';
import { Course } from '../Domain/Course';
export class CreateCourseUseCase {

    constructor(private courses: CourseRepository) { }

    public async execute (name: string, places: number) {

          const course = new Course(name, places);
          const result = await this.courses.save(course);

          return { courseId: result.insertId };
    }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="truegeneraci-n-de-identificadores"><a class="anchor" href="#truegeneraci-n-de-identificadores"></a>3.7. Generación de identificadores</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Extender <code>Domain/CourseRepository.ts</code> con un nuevo método abstracto para la generación de identificadores.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">import { Course } from './Course';

export abstract class CourseRepository {
    abstract save(course: Course);
    // Aquí irían otros métodos p.e courseByStudent

    abstract nextIdentity(): number;
}</code></pre>
</div>
</div>
</li>
<li>
<p>Modificar la entidad <code>Domain/Course.ts</code> añadiéndole el <code>id</code> al constructor y creando un método <code>getId()</code> que devuelve el <code>id</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">...
export class Course {
    private id: number;
    private name: string;
    private places: number;

    constructor (id: number, name: string, places: number) { <i class="conum" data-value="1"></i><b>(1)</b>
        this.id = id; <i class="conum" data-value="2"></i><b>(2)</b>
        this.name = name;
        this.places = places;

...

    public getId() { <i class="conum" data-value="3"></i><b>(3)</b>
      return this.id;
    }

...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Modificación del constructor para añadirle el <code>id</code> como parámetro</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Asignación del <code>id</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Getter necesario para cuando se haga se vaya a persistir.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Modificar el caso de uso para obtener el <code>id</code> del repositorio y pasarlo en la creación del curso.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">import { createConnection } from 'typeorm';
import { InvalidArgumentException } from '../Domain/InvalidArgumentException';
import { CourseRepository } from '../Domain/CourseRepository';
import { Course } from '../Domain/Course';
export class CreateCourseUseCase {

    constructor(private courses: CourseRepository) { }

    public async execute (name: string, places: number) {

          const courseId = await this.courses.nextIdentity(); <i class="conum" data-value="1"></i><b>(1)</b>
          const course = new Course(courseId, name, places); <i class="conum" data-value="2"></i><b>(2)</b>
          const result = await this.courses.save(course);

          return { courseId: result.insertId };
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Solicitar la creación de un identificador para el curso.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Crear el curso usando el identificador obtenido.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Modificar el repositorio MySQL para implementar el método <code>nextIdentity()</code> y para modificar el <code>INSERT</code> y que ahora se le pase el <code>id</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Haremos una generación de identificadores muy sencilla y sólo con propósitos ilustrativos, generando como <code>id</code> el tiempo Unix en segundos, lo que a todas vistas no es válido porque generaría el mismo <code>id</code> para peticiones que llegasen en el mismo segundo.</p>
</div>
<div class="paragraph">
<p>Un enfoque basado en secuencias (p.e. Oracle, PostgreSQL) o en <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">UUID</a> sería mucho más apropiado. Pero para no andar cambiando en este ejemplo el esquema de la base de datos y la entidad para que ahora admitan cadenas UUID en lugar de números lo dejaremos así.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">import { CourseRepository } from '../Domain/CourseRepository';
import { Course } from '../Domain/Course';
import { createConnection } from 'typeorm';

export class MySQLCourseRepository extends CourseRepository {

    nextIdentity(): number { <i class="conum" data-value="1"></i><b>(1)</b>
      return Math.floor(Date.now() / 1000);
    }

    async save(course: Course) {
        const connection = await this.getConnection();

        const result = await connection.query( <i class="conum" data-value="2"></i><b>(2)</b>
          'INSERT INTO courses(id, name, places) VALUES(?, ?, ?)',
          [course.getId(), course.getName(), course.getPlaces()],
        );

        connection.close();

        return result;
    }
    getConnection() {
        return createConnection({
          type: 'mysql',
          host: 'localhost',
          port: 3306,
          username: 'root',
          password: 'secret',
          database: 'ual',
        });
      }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implementación de la generación del identificador. Sólo con propósitos ilustrativos.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Paso del <code>id</code> en el <code>INSERT</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truemejora-de-la-implementaci-n-del-repositorio-mysql"><a class="anchor" href="#truemejora-de-la-implementaci-n-del-repositorio-mysql"></a>3.8. Mejora de la implementación del repositorio MySQL</h3>
<div class="paragraph">
<p>Con lo que tenemos hasta ahora, se crea una conexión en cada uso y es que el repositorio no se comparte entre peticiones. Se trata de un problema relacionado con la gestión del ciclo de vida de las conexiones y del repositorio y esto se resuelve con un <em>contenedor de inyección de dependencias</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Comenzamos por sustituir la creación del caso de uso en el controlador <code>app.controller.ts</code> por una inyección de dependencias.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">...
@Controller()
export class AppController {
  constructor(private readonly appService: AppService,
    private useCase: CreateCourseUseCase) {} <i class="conum" data-value="1"></i><b>(1)</b>

  @Post('/courses')
  @ApiTags('courses')
  async createCourse(@Body() req: CreateCourseRequest): Promise&lt;object&gt; {
    try {
      const result = await this.useCase.execute(req.name, req.places); <i class="conum" data-value="2"></i><b>(2)</b>
      return result;
    } catch (error) {
      throw new BadRequestException(error.message);
    }
  }
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inyección del caso de uso en el constructor.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Llamada al caso de uso como una variable miembro.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Al haber inyectado el caso de uso se ha <em>perdido</em> el uso del repositorio MySQL. Antes de la inyección, el código que teníamos era el siguiente</p>
</div>
<div class="paragraph">
<p><code>const useCase = new CreateCourseUseCase(new MySQLCourseRepository());</code></p>
</div>
<div class="paragraph">
<p>Queda entonces pendiente inyectar el <code>MySQLCourseRepository</code> al caso de uso. Esto pasa por convertir al caso de uso en un <em>provider</em>. En los pasos siguientes se indica la solución a este problema.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Convertir al caso de uso <code>Application/CreateCourseUeCase.ts</code> en un <em>provider</em> añadiéndole el decorador <code>Injectable()</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">@Injectable() <i class="conum" data-value="1"></i><b>(1)</b>
export class CreateCourseUseCase {

    constructor(private courses: CourseRepository) { }

    public async execute (name: string, places: number) {

          const courseId = await this.courses.nextIdentity();
          const course = new Course(courseId, name, places);
          const result = await this.courses.save(course);

          return { courseId: result.insertId };
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uso del decorador <code>Injectable()</code></td>
</tr>
</table>
</div>
</li>
<li>
<p>Modificación de <code>app.module.ts</code> para incorporar al caso de uso <code>CreateCourseUseCase</code> como <em>provider</em>. Se trata de una modificación doble. Por un lado hay que inyectar el provider. Por otro lado hay que inyectar la clase concreta con la que se inicializa el provider.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">@Module({
  imports: [],
  controllers: [AppController],
  providers: [AppService,
    CreateCourseUseCase, <i class="conum" data-value="1"></i><b>(1)</b>
    {provide: CourseRepository, useClass: MySQLCourseRepository}], <i class="conum" data-value="2"></i><b>(2)</b>
})
export class AppModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>CreateCourseUseCase como `provider</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>Inicialización del parámetro `CourseRepository</code> del constructor de <code>CreateCourseUseCase</code> con la clase <code>MySQLCourseRepository</code></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El caso de uso <code>CourseRepositoryUseCase</code> se inicializaba con un parámetro <code>courses</code> de tipo <code>CourseRepository</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">@Injectable()
export class CreateCourseUseCase {

    constructor(private courses: CourseRepository) { } <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>CourseRepository</code> como tipo del parámetro del constructor del caso de uso</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Inicialización de un <em>provider</em></div>
<div class="paragraph">
<p>Partimos de que queremos pasar del uso directo de un caso de uso inicializado con una clase a su uso como en forma de inyección de dependencias. Esta era la situación inicial:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">...
const useCase = new CreateCourseUseCase(new MySQLCourseRepository());
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando en NestJS necesitamos inyectar un provider no sólo como interfaz, sino inicializado con una clase, se tienen que hacer dos modificaciones en <code>app.module.ts</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Añadir la clase del provider al array <code>providers</code> (p.e. <code>CreateCourseUseCase</code>)</p>
</li>
<li>
<p>Añadir un JSON al array <code>providers</code> en el que se indique el parámetro a inicializar y clase con la que se inicializa.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">{
    provide: CourseRepository, <i class="conum" data-value="1"></i><b>(1)</b>
    useClass: MySQLCourseRepository <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Parámetro a inicializar</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Clase con la que se inicializa el parámetro</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El resultado final en <code>app.provider.ts</code> sería algo así</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">@Module({
  imports: [],
  controllers: [AppController],
  providers: [AppService,
    CreateCourseUseCase, <i class="conum" data-value="1"></i><b>(1)</b>
    {provide: CourseRepository, useClass: MySQLCourseRepository}], <i class="conum" data-value="2"></i><b>(2)</b>
})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Parámetro a inicializar</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Clase con la que se inicializa el parámetro</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Consulta la <a href="https://docs.nestjs.com/fundamentals/custom-providers#class-providers-useclass">documentación oficial de NestJS</a> para obtener más información sobre proveedores de clases (<em>class providers</em>).</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="truesustituci-n-del-mecanismo-de-persistencia"><a class="anchor" href="#truesustituci-n-del-mecanismo-de-persistencia"></a>3.9. Sustitución del mecanismo de persistencia</h3>
<div class="paragraph">
<p>Una de las ventajas que aporta la descomposición que realiza DDD es el desacoplamiento de la infraestructura. En este apartado veremos como usar PostgreSQL como mecanismo de persistencia. Los cambios se limitan a:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Instalar PostgreSQL y su driver.</p>
</li>
<li>
<p>Crear un nuevo repositorio en la carpeta <code>Infrastructure</code> para PostgreSQL como mecanismo de persistencia. El nuevo repositorio implementará los métodos del repositorio abstracto (<code>save</code> y <code>nextIdentity</code>).</p>
</li>
<li>
<p>Sustituir el <code>provider</code> en <code>app.module.ts</code>.</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Creación de un contenedor con PostgreSQL</div>
<div class="paragraph">
<p>Para facilitar la configuración de la base de datos, el script siguiente lanza un contenedor PostgreSQL y crea una base de datos tutorial con el password <code>example</code> (los mismos datos que se usaron para el ejemplo con MySQL)</p>
</div>
<div class="paragraph">
<p>Archivo <code>start-postgres.sh</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#!/bin/bash
set -e

SERVER="postgres";
PW="example";
DB="enrollments";

echo "echo stop &amp; remove old docker [$SERVER] and starting new fresh instance of [$SERVER]"
(docker kill $SERVER || :) &amp;&amp; \
  (docker rm $SERVER || :) &amp;&amp; \
  docker run --name $SERVER -e POSTGRES_PASSWORD=$PW \
  -e PGPASSWORD=$PW \
  -p 5432:5432 \
  -d postgres

# wait for pg to start
echo "sleep wait for pg-server [$SERVER] to start";
SLEEP 3;

# create the db
echo "CREATE DATABASE $DB ENCODING 'UTF-8';" | docker exec -i $SERVER psql -U postgres
echo "\l" | docker exec -i $SERVER psql -U postgres</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Los paquetes de PostgreSQL se instalan con</p>
</div>
<div class="paragraph">
<p><code>npm install pg --save</code></p>
</div>
<div class="paragraph">
<p>Script de inicialización de la base de datos</p>
</div>
<script src="https://gist.github.com/ualmtorres/8356e2554d9150c624327ad09739b8aa.js"></script>
<div class="listingblock">
<div class="title">Archivo <code>Infrastructure/PostgreSQLCourseRepository.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">import { CourseRepository } from '../Domain/CourseRepository';
import { Course } from '../Domain/Course';
import { createConnection } from 'typeorm';

export class PostgreSQLCourseRepository extends CourseRepository {

    async nextIdentity():Promise&lt;number&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
      const connection = await this.getConnection();

      const result = await connection.query(
        "SELECT nextval('courses_id');"
      );

      await connection.close();
      return new Promise((resolve) =&gt; {
        resolve(result[0].nextval);
      });
    }

    async save(course: Course) { <i class="conum" data-value="2"></i><b>(2)</b>
        const connection = await this.getConnection();
        const result = await connection.query(
          'INSERT INTO courses(id, name, places) VALUES($1, $2, $3)',
          [course.getId(), course.getName(), course.getPlaces()],
        );

        await connection.close();

        return result;
    }
    getConnection() {
        return createConnection({ <i class="conum" data-value="3"></i><b>(3)</b>
          type: 'postgres',
          host: 'localhost',
          port: 5432,
          username: 'postgres',
          password: 'example',
          database: 'enrollments',
        });
      }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>La generación de identificadores se hace a través de una secuencia de PostgreSQL.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Realiza un INSERT a partir del curso que se le pasa como parámetro. La forma de componer parámetros varía respecto a MySQL.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configuración de los valores de conexión a la base de datos <code>enrollments</code>.</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Devolución de promesas en lugar de valores primitivos</div>
<div class="paragraph">
<p>El método <code>nextIdentity()</code> del repositorio <code>PostgreSQLCourseRepository.ts</code> es un método asíncrono ya que tiene que realizar una operación con Postgres para que le devuelva el próximo valor de la secuencia. Esto se traduce en que el método debe devolver una promesa. Pero como este repositorio extiende la clase <code>CourseRepository</code>, el método abstracto <code>nextIdentity()</code> de dicha clase ahora deberá devolver una promesa, como se muestra a continuación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">import { Course } from './Course';

export abstract class CourseRepository {
    abstract save(course: Course);
    // Aquí irían otros métodos p.e courseByStudent

    abstract nextIdentity(): Promise&lt;number&gt<i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>nextIdentity()</code> ahora devuelve una promesa.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Además, como <code>MySQLCourseRepository</code> también extendía <code>CourseRepository</code>, tendremos que cambiar también el método <code>nextIdentity()</code> en <code>MySQLCourseRepository</code> para que ahora devuelva una promesa.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">...
export class MySQLCourseRepository extends CourseRepository {

    async nextIdentity(): Promise&lt;number&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
      return new Promise((resolve) =&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
        resolve(Math.floor(Date.now() / 1000));
      });
    }
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>nextIdentity()</code> ahora devuelve una promesa.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creación de la promesa para el valor devuelto.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por último, hay que cambiar en <code>app.module.ts</code> la implementación de <code>CourseRepository</code> que se va a usar, en este caso <code>PostgreSQLCourseRepository</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript" data-lang="typescript">@Module({
  imports: [],
  controllers: [AppController],
  providers: [AppService,
    CreateCourseUseCase,
    {provide: CourseRepository, useClass: PostgreSQLCourseRepository}], <i class="conum" data-value="1"></i><b>(1)</b>
})
export class AppModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configuración de <code>CourseRepository</code> con <code>PostgreSQLCourseRepository</code></td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-04-04 12:51:19 CEST
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>